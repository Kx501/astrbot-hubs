name: Publish Plugin (Reusable)

on:
  workflow_call:
    secrets:
      HUB_PUSH_TOKEN:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Read metadata.yaml
        id: read_metadata
        run: |
          python3 << 'EOF' > metadata_output.json
          import yaml
          import json
          import sys
          import os
          
          if os.path.exists("metadata.yaml"):
              metadata_file = "metadata.yaml"
          elif os.path.exists("metadata.yml"):
              metadata_file = "metadata.yml"
          else:
              print("❌ Error: metadata.yaml or metadata.yml not found", file=sys.stderr)
              sys.exit(1)
          
          try:
              with open(metadata_file, 'r', encoding='utf-8') as f:
                  data = yaml.safe_load(f)
              print(json.dumps(data or {}, ensure_ascii=False))
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(1)
          EOF
          
          METADATA_JSON=$(cat metadata_output.json)
          echo "metadata_json<<EOF" >> $GITHUB_ENV
          echo "$METADATA_JSON" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Plugin Hub
        env:
          HUB_TOKEN: ${{ secrets.HUB_PUSH_TOKEN }}
          METADATA_JSON: ${{ env.metadata_json }}
        run: |
          python3 << 'EOF' > dispatch_payload.json
          import json
          import os
          metadata = json.loads(os.environ.get('METADATA_JSON', '{}'))
          payload = {
              'event_type': 'plugin_update',
              'client_payload': metadata
          }
          print(json.dumps(payload))
          EOF
          
          DISPATCH_BODY=$(cat dispatch_payload.json)
          
          curl -X POST \
            -H "Authorization: token $HUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/Kx501/astrbot-hubs/dispatches \
            -d "$DISPATCH_BODY"
          
          echo "✅ 插件元数据已发送到中心"
